#!/bin/bash

set -e

script_path=$(readlink -f "$0")
directory_path=$(dirname "${script_path}")
installers_path=${directory_path}/../installers

export BREW_PREFIX="${HOME}/local"
export DOWNLOAD_PREFIX="${HOME}/Downloads"

[ -e "${HOME}/.brew" ] && source "${HOME}/.brew"

mkdir -p ${BREW_PREFIX}
mkdir -p ${DOWNLOAD_PREFIX}

download_source() {
  if [ ! -e "$(pkgdownload_path)" ]; then
    wget -c "${pkguri}" -O "$(pkgdownload_path)"
  fi
}

check_source() {
  if [ "${pkgmd5}" != $(md5sum "$(pkgdownload_path)" | cut -d' ' -f1) ]; then
    echo " + md5sum: WRONG"
    exit 1
  fi
}

extract_source() {
  tar xfz $(pkgdownload_path) -C /tmp
}

install_package() {
  cd ${pkgbuild_path}
  ./configure --prefix="${BREW_PREFIX}"
  make
  make install
}

pkgdownload_path() {
  echo "${DOWNLOAD_PREFIX}/${pkgfile}"
}

if [ -e "${installers_path}/${1}/last" ]; then
  # When using `brew ruby`
  source "${installers_path}/${1}/last"
else
  # When using `brew ruby/2.0.0`
  source "${installers_path}/${1}"
fi

pkgbuild_path="/tmp/${pkgname}-${pkgversion}"

download_source
check_source
extract_source
install_package
